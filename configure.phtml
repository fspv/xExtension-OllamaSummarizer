<?php
// Configuration view for the FreshRSS Ollama extension
// Save as: ./extensions/FreshrssOllamaExtension/configure.phtml
declare(strict_types=1);

require_once __DIR__ . '/Configuration.php';
$defaults = Configuration::createDefault();
if (FreshRSS_Context::$user_conf) {
    $config = Configuration::fromUserConfiguration(FreshRSS_Context::$user_conf);
} else {
    $config = $defaults;
}

/** @var FreshrssOllamaExtension $this */
if (!isset($this) || !($this instanceof FreshrssOllamaExtension)) {
    throw new Exception('Extension instance not available');
}
?>


<form action="<?php echo _url('extension', 'configure', 'e', urlencode($this->getName())); ?>" method="post">
    <input type="hidden" name="_csrf" value="<?php echo FreshRSS_Auth::csrfToken(); ?>" />
    <div class="form-group">
        <label class="group-name" for="chrome_host"><?php echo _t('ext.freshrss_ollama.chrome_host'); ?></label>
        <div class="group-controls">
            <input type="text" name="chrome_host" id="chrome_host" value="<?php echo $config->getChromeHost(); ?>" />
            <p class="help"><?php echo _t('ext.freshrss_ollama.chrome_host_help'); ?></p>
        </div>
    </div>

    <div class="form-group">
        <label class="group-name" for="chrome_port"><?php echo _t('ext.freshrss_ollama.chrome_port'); ?></label>
        <div class="group-controls">
            <input type="number" name="chrome_port" id="chrome_port" value="<?php echo $config->getChromePort(); ?>" />
            <p class="help"><?php echo _t('ext.freshrss_ollama.chrome_port_help'); ?></p>
        </div>
    </div>

    <div class="form-group">
        <label class="group-name" for="ollama_host"><?php echo _t('ext.freshrss_ollama.ollama_host'); ?></label>
        <div class="group-controls">
            <input type="text" name="ollama_host" id="ollama_host" value="<?php echo $config->getOllamaHost(); ?>" />
            <p class="help"><?php echo _t('ext.freshrss_ollama.ollama_host_help'); ?></p>
        </div>
    </div>

    <div class="form-group">
        <label class="group-name" for="ollama_model"><?php echo _t('ext.freshrss_ollama.ollama_model'); ?></label>
        <div class="group-controls">
            <input type="text" name="ollama_model" id="ollama_model" value="<?php echo $config->getOllamaModel(); ?>" />
            <p class="help"><?php echo _t('ext.freshrss_ollama.ollama_model_help'); ?></p>
        </div>
    </div>

    <div class="form-group">
        <label class="group-name" for="prompt_template"><?php echo _t('ext.freshrss_ollama.prompt_template'); ?></label>
        <div class="group-controls">
            <textarea name="prompt_template" id="prompt_template" rows="6" style="width: 100%;"><?php echo htmlspecialchars($config->getPromptTemplate()); ?></textarea>
            <p class="help"><?php echo _t('ext.freshrss_ollama.prompt_template_help'); ?></p>
        </div>
    </div>

    <div class="form-group">
        <label class="group-name" for="prompt_length_limit"><?php echo _t('ext.freshrss_ollama.prompt_length_limit'); ?></label>
        <div class="group-controls">
            <input type="number" name="prompt_length_limit" id="prompt_length_limit" min="1024" max="32768" value="<?php echo $config->getPromptLengthLimit(); ?>" />
            <p class="help"><?php echo _t('ext.freshrss_ollama.prompt_length_limit_help'); ?></p>
        </div>
    </div>

    <div class="form-group">
        <label class="group-name" for="context_length"><?php echo _t('ext.freshrss_ollama.context_length'); ?></label>
        <div class="group-controls">
            <input type="number" name="context_length" id="context_length" min="1024" max="32768" value="<?php echo $config->getContextLength(); ?>" />
            <p class="help"><?php echo _t('ext.freshrss_ollama.context_length_help'); ?></p>
        </div>
    </div>

    <div class="form-group">
        <label class="group-name"><?php echo _t('ext.freshrss_ollama.selected_feeds'); ?></label>
        <div class="group-controls">
            <p class="help"><?php echo _t('ext.freshrss_ollama.selected_feeds_help'); ?></p>
            <?php
            $feedDAO = FreshRSS_Factory::createFeedDao();
            $feeds = $feedDAO->listFeeds();
            $selectedFeeds = $config->getSelectedFeeds();
            ?>
            <fieldset style="height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
                <?php foreach ($feeds as $feed): ?>
                    <?php 
                    $tooltip = '';
                    if ($feed->website() !== '') {
                        $tooltip .= 'Website: ' . htmlspecialchars($feed->website()) . "\n";
                    }
                    if ($feed->url() !== '') {
                        $tooltip .= 'URL: ' . htmlspecialchars($feed->url(false)) . "\n";
                    }
                    if ($feed->description() !== '') {
                        $tooltip .= 'Description: ' . htmlspecialchars($feed->description());
                    }
                    $tooltip = trim($tooltip);
                    ?>
                    <div class="feed-checkbox">
                        <label for="feed_<?php echo $feed->id(); ?>" <?php echo $tooltip ? 'title="' . $tooltip . '"' : ''; ?>>
                        <input type="checkbox" 
                               name="selected_feeds[]" 
                               id="feed_<?php echo $feed->id(); ?>" 
                               value="<?php echo $feed->id(); ?>"
                               <?php echo in_array($feed->id(), $selectedFeeds, true) ? 'checked' : ''; ?> />
                            <img src="<?php echo $feed->favicon(); ?>" alt="" height="16" width="16" />
                            <?php echo htmlspecialchars($feed->name()); ?>
                        </label>
                    </div>
                <?php endforeach; ?>
            </fieldset>
        </div>
    </div>

    <div class="form-group form-actions">
        <div class="group-controls">
            <button type="submit" class="btn btn-important"><?= _t('gen.action.submit'); ?></button>
            <button type="reset" class="btn"><?= _t('gen.action.cancel'); ?></button>
        </div>
    </div>
</form>

<?php
$readme_path = __DIR__ . '/README.md';
if (file_exists($readme_path)) {
    echo '<div class="extension-description">';
    echo '<pre>' . htmlspecialchars(file_get_contents($readme_path)) . '</pre>';
    echo '</div>';
}
?>

